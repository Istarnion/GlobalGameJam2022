var N=Object.defineProperty;var W=(i,t,e)=>t in i?N(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var r=(i,t,e)=>(W(i,typeof t!="symbol"?t+"":t,e),e);import{h as X}from"./vendor.1b5b4604.js";const J=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function e(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerpolicy&&(a.referrerPolicy=o.referrerpolicy),o.crossorigin==="use-credentials"?a.credentials="include":o.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(o){if(o.ep)return;o.ep=!0;const a=e(o);fetch(o.href,a)}};J();const p=2*Math.PI;function H(i){return Math.sqrt(i.x*i.x+i.y*i.y)}const y=document.getElementById("game-canvas"),n=y.getContext("2d");function F(){n.imageSmoothingEnabled=!1}const g=window.devicePixelRatio?window.devicePixelRatio:1;n.scale(g,g);n.save();n.width=y.clientWidth;n.height=y.clientHeight;let Y=0;function S(){const i=performance.now();if(i-Y<10)return;Y=i,console.log("resize");const t=window.innerWidth,e=window.innerHeight,s=n.width/n.height,o=t/e;let a=1;o>=s?a=e/n.height:a=t/n.width,a>1&&(a=Math.floor(a)),y.width=n.width*a*g,y.height=n.height*a*g,y.style.width=`${n.width*a}px`,y.style.height=`${n.height*a}px`,n.restore(),n.save(),n.scale(a*g,a*g),F()}window.addEventListener("resize",S);n.setGameSize=function(i,t){this.width=i,this.height=t,S()};n.clear=function(i){this.fillStyle=i,this.clearRect(0,0,n.width,n.height),this.fillRect(0,0,n.width,n.height)};n.drawLine=function(i,t,e,s){this.beginPath(),this.moveTo(i,t),this.lineTo(e,s),this.closePath(),this.stroke()};n.drawCircle=function(i,t,e){this.beginPath(),this.arc(i,t,e,0,p),this.closePath(),this.stroke()};n.fillCircle=function(i,t,e){this.beginPath(),this.arc(i,t,e,0,p),this.closePath(),this.fill()};n.tintTexture=function(i,t){const e=document.createElement("canvas");e.width=i.width,e.height=i.height;const s=e.getContext("2d");s.drawImage(i,0,0),s.globalCompositeOperation="source-in",s.fillStyle=t,s.fillRect(0,0,e.width,e.height);const o=e.toDataURL(),a=new Image(e.width,e.height);return a.src=o,s.globalCompositeOperation="source-in",a};const R={Space:"space",Enter:"enter",ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right",KeyW:"w",KeyA:"a",KeyS:"s",KeyD:"d",KeyQ:"q",KeyE:"e",Digit1:"one",Digit2:"two",Digit3:"three",Digit4:"four",Digit5:"five"};class B{constructor(){r(this,"mouseX",0);r(this,"mouseY",0);r(this,"keys",{});r(this,"mouseButton",[!1,!1]);for(const t in R)this.keys[R[t]]=[!1,!1];window.addEventListener("keydown",t=>{t.preventDefault();const e=R[t.code];e&&(this.keys[e][0]=!0)}),window.addEventListener("keyup",t=>{t.preventDefault();const e=R[t.code];e&&(this.keys[e][0]=!1)}),n.canvas.addEventListener("mousemove",t=>{t.preventDefault();const e=n.width/n.canvas.clientWidth,s=n.canvas.getClientRects()[0];return this.mouseX=(t.clientX-s.x)*e,this.mouseY=(t.clientY-s.y)*e,!1}),n.canvas.addEventListener("mousedown",t=>(t.preventDefault(),t.button===0&&(this.mouseButton[0]=!0),!1)),n.canvas.addEventListener("mouseup",t=>(t.preventDefault(),t.button===0&&(this.mouseButton[0]=!1),!1))}newFrame(){for(const t in this.keys)this.keys[t][1]=this.keys[t][0];this.mouseButton[1]=this.mouseButton[0]}mouseIsPressed(){return!!this.mouseButton[0]}mouseIsJustPressed(){return!!(this.mouseButton[0]&&!this.mouseButton[1])}mouseIsJustReleased(){return!!(!this.mouseButton[0]&&this.mouseButton[1])}keyIsPressed(...t){if(t.length>0){for(let e=0;e<t.length;++e)if(this.keys[t[e]][0])return!0}else for(const e in this.keys)if(this.keys[e][0])return!0;return!1}keyIsJustPressed(...t){if(t.length>0){for(let e=0;e<t.length;++e)if(this.keys[t[e]][0]&&!this.keys[t[e]][1])return!0}else for(const e in this.keys)if(this.keys[e][0]&&!this.keys[e][1])return!0;return!1}keyIsJustReleased(...t){if(t.length>0){for(let e=0;e<t.length;++e)if(!this.keys[t[e]][0]&&this.keys[t[e]][1])return!0}else for(const e in this.keys)if(!this.keys[e][0]&&this.keys[e][1])return!0;return!1}}const u=new B;class _{constructor(){r(this,"time",0);r(this,"slowdown",1);r(this,"dt",1/60)}deltaTime(){return this.dt*this.slowdown}}const m=new _;class U{constructor(t,e){r(this,"loopTimerID",0);r(this,"lastFrameTime");r(this,"states",[]);r(this,"shouldCallResume",!1);r(this,"resumeArgs");n.setGameSize(t,e),this.lastFrameTime=performance.now()}run(t){this.states.push(t),this.states[this.states.length-1].start(),this.update()}quit(){var t;do(t=this.states.pop())==null||t.end();while(this.states.length>0);window.cancelAnimationFrame(this.loopTimerID),document.removeChild(n.canvas)}pushState(t,e){this.states[this.states.length-1].pause(),this.states.push(t),this.shouldCallResume=!1,t.start(e)}popState(t){var e;this.states.length>1?((e=this.states.pop())==null||e.end(),this.shouldCallResume=!0,this.resumeArgs=t):console.error("Trying to pop the last game state of the state stack!")}peekState(){return this.states[this.states.length-1]}update(){this.loopTimerID=window.requestAnimationFrame(()=>this.update());const t=performance.now(),e=(t-this.lastFrameTime)/1e3;m.dt=e,m.time+=e,this.shouldCallResume&&(this.shouldCallResume=!1,this.states[this.states.length-1].resume(this.resumeArgs)),this.states[this.states.length-1].update(),n.clear("black");for(const s of this.states)s.draw();this.lastFrameTime=t,u.newFrame()}}class I{start(t){}end(){}resume(t){}pause(){}update(){}draw(){}}class j{constructor(){r(this,"clips");this.clips={},this.load("menu","./res/audio/music/menu.mp3",!0),this.load("pee","./res/audio/sfx/pee.mp3",!1),this.load("battle","./res/audio/music/battle.mp3",!0)}load(t,e,s,o=1){const a=new X.Howl({src:e,loop:s,volume:o});this.clips[t]=a}play(t,e=1){this.clips[t].volume(e),this.clips[t].play()}fadeOut(t,e){let s=this.clips[t];s.fade(s.volume(),0,e),s.on("fade",()=>{s.stop()})}}const E=new j;var h;(function(i){i[i.INVALID_TYPE=0]="INVALID_TYPE",i[i.PEAPROJECTILE=1]="PEAPROJECTILE",i[i.ENEMY=2]="ENEMY",i[i.SHADOW=3]="SHADOW",i[i.HURTABLE=4]="HURTABLE",i[i.TILEMAP=5]="TILEMAP",i[i.ANIMATOR=6]="ANIMATOR",i[i.COLLIDER=7]="COLLIDER",i[i.MOVER=8]="MOVER",i[i.TEXT=9]="TEXT",i[i.PLAYER=10]="PLAYER",i[i.NUM_TYPES=11]="NUM_TYPES"})(h||(h={}));class w{constructor(t,e){r(this,"type",0);r(this,"active",!0);r(this,"entity");this.entity=t,this.type=e}awake(){}update(){}render(){}destroy(){}get world(){return this.entity.world}}const T={},x={};function q(i,t){return new Promise((e,s)=>{const o=new Image;o.onload=()=>{T[i]=o,e(o)},o.onerror=()=>{s(t)},o.src=t})}function K(i){return new Promise((t,e)=>{if(i.length===0){t();return}const s=[];i.forEach(o=>{s.push(q(o[0],o[1]))}),Promise.all(s).then(()=>{t()}).catch(o=>{e(o)})})}function z(i){return new Promise((t,e)=>{fetch(i,{method:"GET"}).then(s=>s.json()).then(s=>{t(s)}).catch(s=>{console.error(`Failed to load "${i}": ${s}`),e()})})}function k(i){return new Promise((t,e)=>{z(i).then(s=>{for(const o in s)x[o]=s[o];t(x)}).catch(()=>{e()})})}class v extends w{constructor(t,e,s){super(s,h.ANIMATOR);r(this,"xOffset",0);r(this,"yOffset",0);r(this,"img");r(this,"sprite");r(this,"frameIndex",0);r(this,"frameTime",0);r(this,"current");r(this,"currentAnim");r(this,"columns");this.sprite=t,this.img=T[t.image],console.assert(this.img!==void 0,"Failed to load image for animation"),this.columns=this.sprite.width/this.sprite.frameWidth|0,this.current=e,this.currentAnim=this.sprite.anims[this.current]}play(t){t!==this.current&&(this.current=t,this.currentAnim=this.sprite.anims[t],this.frameTime=0,this.frameIndex=0)}awake(){this.frameIndex=0,this.frameTime=0}update(){const t=m.deltaTime()*1e3;for(this.frameTime+=t;this.frameTime>=this.currentAnim.framedurations[this.frameIndex];)this.frameTime-=this.currentAnim.framedurations[this.frameIndex],this.frameIndex+=1,this.frameIndex>=this.currentAnim.framedurations.length&&(this.frameIndex=0)}render(){if(this.entity.visible){const t=this.currentAnim.start+this.frameIndex,e=t%this.columns*this.sprite.frameWidth,s=(t/this.columns|0)*this.sprite.frameHeight;n.drawImage(this.img,e,s,this.sprite.frameWidth,this.sprite.frameHeight,this.entity.position.x+this.xOffset,this.entity.position.y+this.yOffset,this.sprite.frameWidth,this.sprite.frameHeight)}}}class A extends w{constructor(t,e,s){super(s,h.COLLIDER);r(this,"mask");r(this,"radius");r(this,"debugDraw",!1);this.radius=t,this.mask=e}render(){this.debugDraw&&(n.strokeStyle="red",n.drawCircle(this.entity.position.x,this.entity.position.y,this.radius))}collidesAt(t,e,s){return this.firstCollisionAt(t,e,s)!==null}firstCollisionAt(t,e,s){for(const o of this.world.all(h.COLLIDER))if((o.mask&t)!=0&&this.collidesWithAt(o,e,s))return o;return null}allCollisionsAt(t,e,s){const o=[];for(const a of this.world.all(h.COLLIDER))(a.mask&t)!=0&&this.collidesWithAt(a,e,s)&&o.push(a);return o}collidesWithAt(t,e,s){const o=this.entity.position.x+e-t.entity.position.x,a=this.entity.position.y+s-t.entity.position.y,l=o*o+a*a,c=this.radius+t.radius;return l<=c*c}}class M extends w{constructor(t){super(t,h.ENEMY)}}class P extends w{constructor(t,e,s){super(s,h.HURTABLE);r(this,"hurtBy");r(this,"collider");r(this,"onHurt");this.hurtBy=e,this.onHurt=t,this.collider=this.entity.first(h.COLLIDER)}update(){this.collider.collidesAt(this.hurtBy,0,0)&&(this.onHurt?this.onHurt():this.world.destroyEntity(this.entity))}}var d;(function(i){i[i.NONE=0]="NONE",i[i.SOLID=1]="SOLID",i[i.PLAYER=4]="PLAYER",i[i.ENEMY=8]="ENEMY",i[i.PLAYER_PROJECTILE=16]="PLAYER_PROJECTILE",i[i.ENEMY_PROJECTILE=32]="ENEMY_PROJECTILE"})(d||(d={}));class G extends w{constructor(t,e){super(e,h.MOVER);r(this,"inputx",0);r(this,"inputy",0);r(this,"speed",64);r(this,"xError",0);r(this,"yError",0);r(this,"collider");r(this,"onCollisionX");r(this,"onCollisionY");this.speed=t}update(){const t=m.deltaTime();let e=this.inputx,s=this.inputy;if(Math.abs(e)+Math.abs(s)>1){const o=Math.sqrt(e*e+s*s);e/=o,s/=o}this.moveX(e*this.speed*t),this.moveY(s*this.speed*t)}moveX(t){if(this.collider){if(this.xError+=t,t=Math.round(this.xError),Math.abs(t)>0){const e=Math.sign(t);for(;t!==0;){if(this.collider.collidesAt(d.SOLID,e,0)){this.onCollisionX?this.onCollisionX(this):this.stopX();break}this.entity.position.x+=e,t-=e,this.xError-=e}}}else this.entity.position.x+=t}moveY(t){if(this.collider){if(this.yError+=t,t=Math.round(this.yError),Math.abs(t)>0){const e=Math.sign(t);for(;t!==0;){if(this.collider.collidesAt(d.SOLID,0,e)){this.onCollisionY?this.onCollisionY(this):this.stopY();break}this.entity.position.y+=e,t-=e,this.xError-=e}}}else this.entity.position.y+=t}stopX(){this.xError=0}stopY(){this.xError=0}}class V extends w{constructor(t){super(t,h.PEAPROJECTILE);r(this,"dx",0);r(this,"dy",0);E.play("pee")}update(){const t=m.deltaTime();this.entity.position.x+=this.dx*t,this.entity.position.y+=this.dy*t,H(this.entity.position)>256&&this.world.destroyEntity(this.entity)}render(){n.fillStyle="lime",n.fillCircle(this.entity.position.x,this.entity.position.y,2)}}class ${constructor(t){r(this,"world");r(this,"cooldown",.1);this.world=t}fire(t,e,s){t+=Math.cos(s-p/4)*8,e+=Math.sin(s-p/4)*8,b(t,e,s,128,d.PLAYER_PROJECTILE,this.world)}}class Q extends w{constructor(t){super(t,h.PLAYER);r(this,"mover");r(this,"animator");r(this,"weapon");r(this,"weaponCooldown",0);r(this,"firedWeapon",!1);r(this,"dying",!1);this.mover=this.entity.first(h.MOVER),this.animator=this.entity.first(h.ANIMATOR),this.weapon=new $(this.world)}awake(){this.entity.first(h.COLLIDER),this.animator.play("stand weapon1")}update(){if(this.dying)this.mover.inputx=this.mover.inputy=0,this.animator.play("death"),this.animator.frameIndex===2&&this.animator.frameTime>=50&&this.world.destroyEntity(this.entity);else{const t=this.world.screenToWorld(u.mouseX,u.mouseY),e=t[0]-this.entity.position.x,s=t[1]-this.entity.position.y;this.entity.rotation=Math.atan2(s,e)+p/4,this.mover.inputx=this.mover.inputy=0,u.keyIsPressed("up","w")&&(this.mover.inputy-=1),u.keyIsPressed("down","s")&&(this.mover.inputy+=1),u.keyIsPressed("left","a")&&(this.mover.inputx-=1),u.keyIsPressed("right","d")&&(this.mover.inputx+=1),this.firedWeapon=!1,this.weaponCooldown<=0?u.mouseIsJustPressed()&&(this.weapon.fire(this.entity.position.x,this.entity.position.y,this.entity.rotation),this.firedWeapon=!0):this.weaponCooldown-=m.deltaTime(),Math.abs(this.mover.inputx)+Math.abs(this.mover.inputy)>0?this.animator.play("move weapon1"):this.animator.play("stand weapon1")}}}class Z extends w{constructor(t){super(t,h.SHADOW);r(this,"startX");r(this,"startY");this.startX=this.entity.position.x,this.startY=this.entity.position.y}}function tt(i,t,e){const s=e.addEntity(i,t);s.add(new A(6,d.PLAYER,s)),s.add(new G(64,s));const o=s.add(new v(x.maincharacter,"stand weapon1",s));o.xOffset=-16,o.yOffset=-21;const a=s.add(new Q(s)),l=()=>{a.dying=!0};return s.add(new P(l,d.ENEMY|d.ENEMY_PROJECTILE,s)),s}function b(i,t,e,s,o,a){const l=a.addEntity(i,t),c=l.add(new V(l));return e-=p/4,c.dx=Math.cos(e)*s,c.dy=Math.sin(e)*s,l.add(new A(2,o,l)),o===d.PLAYER_PROJECTILE?d.ENEMY|d.PLAYER:d.PLAYER,l.add(new P(null,d.PLAYER,l)),l}function et(i,t,e){const s=e.addEntity(i,t);s.add(new A(8,d.ENEMY,s));const o=s.add(new v(x.slime,"move",s));return o.xOffset=-8,o.yOffset=-8,s.add(new P(null,d.PLAYER_PROJECTILE,s)),s.add(new M(s)),s}function st(i,t,e){const s=e.addEntity(i,t);s.rotation=p/2,s.add(new A(6,d.ENEMY,s));const o=s.add(new v(x.maincharactershadow,"stand weapon1",s));return o.xOffset=-16,o.yOffset=-21,s.add(new P(null,d.PLAYER_PROJECTILE,s)),s.add(new M(s)),s.add(new Z(s)),s}class it{constructor(t,e,s,o){r(this,"x");r(this,"y");r(this,"rotation");r(this,"shoot",!1);this.x=t,this.y=e,this.rotation=s,this.shoot=o}}class rt{constructor(){r(this,"recordings",[]);r(this,"currentIndex",0);r(this,"backwards",!1)}add(t){this.recordings.push(t)}get(t){return this.recordings[t]}getNext(){const t=this.recordings[this.currentIndex];return this.backwards?(this.currentIndex--,this.currentIndex==0&&(this.backwards=!1)):(this.currentIndex++,this.currentIndex==this.recordings.length-1&&(this.backwards=!0)),t}}class nt{constructor(t){r(this,"active",!0);r(this,"world");r(this,"position",{x:0,y:0});r(this,"rotation",0);r(this,"visible",!0);r(this,"components",[]);this.world=t}first(t){for(const e of this.components)if(e.type===t)return e;return null}add(t){return this.components.push(t),this.world.add(t),t}}class ot{constructor(){r(this,"entities",new Array);r(this,"components");r(this,"cameraX",0);r(this,"cameraY",0);this.components=[];for(let t=1;t<h.NUM_TYPES;++t)this.components.push([])}update(){for(const t of this.components)for(const e of t)e.active&&e.entity.active&&e.update()}render(){n.save(),n.translate(n.width/2-this.cameraX,n.height/2-this.cameraY),n.strokeStyle="white",n.drawCircle(0,0,64);for(const t of this.components)for(const e of t)e.active&&e.entity.active&&(n.save(),e.entity.rotation!==0&&(n.translate(e.entity.position.x,e.entity.position.y),n.rotate(e.entity.rotation),n.translate(-e.entity.position.x,-e.entity.position.y)),e.render(),n.restore());n.restore()}screenToWorld(t,e){return[t-n.width/2+this.cameraX,e-n.height/2+this.cameraY]}worldToScreen(t,e){return[t+n.width/2-this.cameraX,e+n.height/2-this.cameraY]}addEntity(t,e){const s=new nt(this);return s.position={x:t,y:e},this.entities.push(s),s}destroyEntity(t){t.active=!1;for(const e of t.components)this.destroy(e);for(let e=0;e<this.entities.length;++e)if(this.entities[e]===t){this.entities.splice(e,1);break}}first(t){return this.components[t].length>0?this.components[t-1][0]:null}all(t){return this.components[t-1]}add(t){return this.components[t.type-1].push(t),t.awake(),t}destroy(t){t.alive=!1;const e=this.components[t.type-1];for(let s=0;s<e.length;++s)if(e[s]===t){e.splice(s,1);break}t.destroy()}}class at extends I{constructor(t,e){super();r(this,"duration");r(this,"t",0);r(this,"onFadeComplete");this.duration=t,this.onFadeComplete=e}update(){this.t+=m.deltaTime(),this.t>=this.duration&&(f.popState(),this.onFadeComplete&&this.onFadeComplete())}draw(){n.fillStyle=`rgba(0, 0, 0, ${this.t/this.duration}`,n.fillRect(0,0,n.width,n.height)}}class ht extends I{constructor(t){super();r(this,"duration");r(this,"t",0);this.duration=t}update(){this.t+=m.deltaTime(),this.t>=this.duration&&f.popState()}draw(){n.fillStyle=`rgba(0, 0, 0, ${1-this.t/this.duration}`,n.fillRect(0,0,n.width,n.height)}}class L extends I{constructor(t,e){super();r(this,"world");r(this,"player");r(this,"currentLevel",0);r(this,"recordings",[]);r(this,"shadows",[]);r(this,"currentRecording");if(this.world=new ot,this.player=tt(0,0,this.world),this.currentLevel=t,this.recordings=e,this.currentRecording=new rt,t===0)et(0,-32,this.world);else{let s=0;for(let a=0;a<e.length;++a)s+=e.length-a,this.shadows.push([]);let o=32*e.length;for(let a=0;a<e.length;++a){const l=e.length-a;let c=0;for(let O=0;O<l;++O){const C=Math.cos(c)*o,D=Math.sin(c)*o;this.shadows[a].push(st(C,D,this.world).first(h.SHADOW)),c+=p/l}o-=32}}console.log(t)}update(){if(!this.player.active){f.popState();return}for(let t=0;t<this.recordings.length;++t){const e=this.recordings[t].getNext();for(const s of this.shadows[t])s.entity.active&&(s.entity.position.x=s.startX+e.x,s.entity.position.y=s.startY+e.y,s.entity.rotation=e.rotation,e.shoot&&b(s.entity.position.x,s.entity.position.y,s.entity.rotation,128,d.ENEMY_PROJECTILE,this.world))}this.world.update(),this.world.cameraX=this.player.position.x,this.world.cameraY=this.player.position.y,this.currentRecording.add(new it(this.player.position.x,this.player.position.y,this.player.rotation,this.player.first(h.PLAYER).firedWeapon)),this.world.all(h.ENEMY).length===0&&this.onNewLevel()}draw(){n.clear("black"),this.world.render()}onNewLevel(){this.recordings.push(this.currentRecording),f.pushState(new at(1,()=>{f.popState(),f.pushState(new L(++this.currentLevel,this.recordings)),f.pushState(new ht(1))}))}}class lt extends I{constructor(){super();E.play("menu")}update(){u.mouseIsJustPressed()&&(f.pushState(new L(0,[])),E.fadeOut("menu",500),E.play("battle",.7))}draw(){n.fillStyle="white",n.fillText("Click to start",n.width/2,n.height/2)}resume(t){E.fadeOut("battle",500),E.play("menu")}}const f=new U(200,600/4),dt=[K([["crate","./res/crate.png"],["cthulhupotato","./res/cthulhupotato.png"],["maincharacter","./res/maincharacter.png"],["maincharactershadow","./res/maincharactershadow.png"],["pickups","./res/pickups.png"],["slime","./res/slime.png"]]),k("./res/sprites.json"),k("./res/sprites_shadow.json")];Promise.all(dt).then(i=>{f.run(new lt)});
